<section class="card form-card">
  <header class="section-header">
    <div>
      <h2>مدیریت مشتری‌ها</h2>
      <p class="muted">افزودن مشتری جدید یا ویرایش اطلاعات مشتری‌های ثبت شده.</p>
    </div>
    <button class="outline" type="button" (click)="startCreateClient()" [disabled]="isSubmitting">
      افزودن مشتری جدید
    </button>
  </header>

  <p class="success" *ngIf="formSuccessMessage">{{ formSuccessMessage }}</p>
</section>

<div class="modal-backdrop" *ngIf="isFormModalOpen" (click)="closeFormModal()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <div>
        <h3>{{ isEditMode ? 'ویرایش اطلاعات مشتری' : 'ثبت مشتری جدید' }}</h3>
        <p class="muted">اطلاعات مشتری را وارد کنید.</p>
      </div>
      <button type="button" class="close-button" (click)="closeFormModal()" [disabled]="isSubmitting">
        بستن
      </button>
    </header>

    <div class="modal-tabs">
      <button
        type="button"
        [class.active]="modalActiveTab === 'details'"
        (click)="setModalTab('details')"
      >
        اطلاعات
      </button>
      <button
        type="button"
        [class.active]="modalActiveTab === 'calls'"
        (click)="setModalTab('calls')"
      >
        تماس‌ها
      </button>
      <button
        type="button"
        [class.active]="modalActiveTab === 'tasks'"
        (click)="setModalTab('tasks')"
      >
        پیگیری‌ها
      </button>
      <button
        type="button"
        [class.active]="modalActiveTab === 'appointments'"
        (click)="setModalTab('appointments')"
      >
        نوبت‌ها
      </button>
      <button
        type="button"
        [class.active]="modalActiveTab === 'treatment'"
        (click)="setModalTab('treatment')"
      >
        طرح درمان
      </button>
    </div>

    <p class="error" *ngIf="formErrorMessage">{{ formErrorMessage }}</p>

    <ng-container *ngIf="modalActiveTab === 'details'">
      <form class="client-form" (ngSubmit)="submitClient()">
        <div class="form-grid">
          <label>
            نام
            <input type="text" name="firstName" [(ngModel)]="formData.firstName" />
          </label>
          <label>
            نام خانوادگی
            <input type="text" name="lastName" [(ngModel)]="formData.lastName" />
          </label>
          <label>
            عنوان
            <input type="text" name="title" [(ngModel)]="formData.title" required />
          </label>
          <label>
            موبایل ۱
            <input type="text" name="mobileNumber1" [(ngModel)]="formData.mobileNumber1" required />
          </label>
          <label>
            موبایل ۲
            <input type="text" name="mobileNumber2" [(ngModel)]="formData.mobileNumber2" />
          </label>
          <label>
            تلفن ثابت
            <input type="text" name="phoneNumber" [(ngModel)]="formData.phoneNumber" />
          </label>
          <label>
            ایمیل
            <input type="email" name="email" [(ngModel)]="formData.email" />
          </label>
          <label>
            تاریخ تولد
            <input type="date" name="birthDay" [(ngModel)]="formData.birthDay" />
          </label>
          <label>
            نوع خدمات
            <select name="dentalService" [(ngModel)]="formData.dentalService">
              <option *ngFor="let service of dentalServiceOptions" [ngValue]="service.value">
                {{ service.label }}
              </option>
            </select>
          </label>
          <label class="full">
            آدرس
            <input type="text" name="address" [(ngModel)]="formData.address" />
          </label>
          <label>
            استان
            <input type="text" name="province" [(ngModel)]="formData.province" />
          </label>
          <label>
            شهر
            <input type="text" name="city" [(ngModel)]="formData.city" />
          </label>
          <label>
            کد پستی
            <input type="text" name="postalCode" [(ngModel)]="formData.postalCode" />
          </label>
          <label>
            کشور
            <input type="text" name="country" [(ngModel)]="formData.country" />
          </label>
          <label class="full">
            توضیحات
            <textarea name="description" rows="3" [(ngModel)]="formData.description"></textarea>
          </label>
        </div>
        <div class="form-actions">
          <button type="submit" [disabled]="isSubmitting">
            {{ isEditMode ? 'ذخیره تغییرات' : 'ثبت مشتری' }}
          </button>
          <button type="button" class="outline" (click)="startCreateClient()" [disabled]="isSubmitting">
            پاک کردن فرم
          </button>
        </div>
      </form>
    </ng-container>

    <ng-container *ngIf="modalActiveTab === 'calls'">
      <div class="modal-calls-header">
        <div>
          <p class="muted">تماس‌های مرتبط با موبایل مشتری را بررسی کنید.</p>
          <p class="muted">شماره انتخابی: {{ modalSelectedPhone || '---' }}</p>
        </div>
        <div class="table-actions">
          <button
            type="button"
            class="outline"
            (click)="selectModalPhone(formData.mobileNumber1)"
            [disabled]="!formData.mobileNumber1"
          >
            موبایل ۱
          </button>
          <button
            type="button"
            class="outline"
            (click)="selectModalPhone(formData.mobileNumber2)"
            [disabled]="!formData.mobileNumber2"
          >
            موبایل ۲
          </button>
        </div>
      </div>

      <div class="filters">
        <label>
          از تاریخ
          <input type="date" [(ngModel)]="startDate" />
        </label>
        <label>
          تا تاریخ
          <input type="date" [(ngModel)]="endDate" />
        </label>
        <button type="button" (click)="loadModalCallRecords()" [disabled]="modalIsLoadingCalls">
          {{ modalIsLoadingCalls ? 'در حال دریافت...' : 'نمایش تماس‌ها' }}
        </button>
      </div>

      <p class="error" *ngIf="modalCallsErrorMessage">{{ modalCallsErrorMessage }}</p>

      <div class="calls" *ngIf="modalCallRecords.length">
        <table>
          <thead>
            <tr>
              <th>تاریخ تماس</th>
              <th>تماس‌گیرنده</th>
              <th>شماره مقصد</th>
              <th>مدت زمان</th>
              <th>وضعیت</th>
              <th>فایل ضبط</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let call of modalCallRecords">
              <td>{{ call.callDate | date: 'yyyy/MM/dd HH:mm' }}</td>
              <td>{{ call.src }}</td>
              <td>{{ call.dst }}</td>
              <td>{{ call.duration }} ثانیه</td>
              <td>{{ call.disposition }}</td>
              <td>
                <ng-container *ngIf="call.recordingFile; else modalNoRecording">
                  <audio controls [src]="getRecordingUrl(call.recordingFile)"></audio>
                  <a
                    class="recording-link"
                    [href]="getRecordingUrl(call.recordingFile)"
                    target="_blank"
                    rel="noopener"
                  >
                    پخش در تب جدید
                  </a>
                </ng-container>
                <ng-template #modalNoRecording>---</ng-template>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <p class="muted" *ngIf="!modalCallRecords.length && !modalIsLoadingCalls">
        تماسی برای نمایش وجود ندارد.
      </p>
    </ng-container>

    <ng-container *ngIf="modalActiveTab === 'tasks'">
      <div class="tasks-header">
        <div>
          <p class="muted">برای هر مشتری پیگیری ثبت کنید تا در تاریخ و ساعت مشخص یادآوری شود.</p>
          <p class="muted" *ngIf="!formData.id">برای ثبت پیگیری ابتدا باید مشتری ذخیره شود.</p>
        </div>
      </div>

      <div class="task-form">
        <label>
          تاریخ
          <input type="date" name="taskDate" [(ngModel)]="taskForm.date" />
        </label>
        <label>
          ساعت
          <input type="time" name="taskTime" [(ngModel)]="taskForm.time" />
        </label>
        <label class="full">
          موضوع پیگیری
          <input type="text" name="taskSubject" [(ngModel)]="taskForm.subject" />
        </label>
        <label class="full">
          توضیحات تکمیلی
          <textarea name="taskDescription" rows="3" [(ngModel)]="taskForm.description"></textarea>
        </label>
      </div>

      <div class="form-actions">
        <button type="button" (click)="addTask()" [disabled]="!canAddTask()">
          ثبت پیگیری
        </button>
        <button type="button" class="outline" (click)="resetTaskForm()">
          پاک کردن
        </button>
      </div>

      <p class="error" *ngIf="taskErrorMessage">{{ taskErrorMessage }}</p>
      <p class="success" *ngIf="taskSuccessMessage">{{ taskSuccessMessage }}</p>

      <div class="tasks-table" *ngIf="modalTasks.length">
        <table>
          <thead>
            <tr>
              <th>تاریخ و ساعت</th>
              <th>موضوع</th>
              <th>توضیحات</th>
              <th>وضعیت</th>
              <th>مدیریت</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let task of modalTasks">
              <td>{{ task.date }} - {{ task.time }}</td>
              <td>{{ task.subject }}</td>
              <td>{{ task.description || '---' }}</td>
              <td>
                <span class="status-pill" [class.done]="task.isDone">
                  {{ task.isDone ? 'انجام شد' : 'در انتظار' }}
                </span>
              </td>
              <td>
                <div class="table-actions">
                  <button type="button" class="outline" (click)="toggleTaskDone(task)">
                    {{ task.isDone ? 'بازگشت' : 'انجام شد' }}
                  </button>
                  <button type="button" class="danger" (click)="deleteTask(task)">حذف</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <p class="muted" *ngIf="!modalTasks.length">پیگیری ثبت نشده است.</p>
    </ng-container>

    <ng-container *ngIf="modalActiveTab === 'appointments'">
      <div class="appointments-header">
        <div>
          <p class="muted">برای هر مشتری نوبت ثبت کنید تا برنامه‌ریزی مراجعه مشخص باشد.</p>
          <p class="muted" *ngIf="!formData.id">برای ثبت نوبت ابتدا باید مشتری ذخیره شود.</p>
        </div>
      </div>

      <div class="appointment-form">
        <label>
          تاریخ
          <input type="date" name="appointmentDate" [(ngModel)]="appointmentForm.date" />
        </label>
        <label>
          ساعت
          <input type="time" name="appointmentTime" [(ngModel)]="appointmentForm.time" />
        </label>
        <label class="full">
          نوع نوبت
          <input type="text" name="appointmentService" [(ngModel)]="appointmentForm.service" />
        </label>
        <label class="full">
          توضیحات
          <textarea name="appointmentNotes" rows="3" [(ngModel)]="appointmentForm.notes"></textarea>
        </label>
      </div>

      <div class="form-actions">
        <button type="button" (click)="addAppointment()" [disabled]="!canAddAppointment()">
          ثبت نوبت
        </button>
        <button type="button" class="outline" (click)="resetAppointmentForm()">
          پاک کردن
        </button>
      </div>

      <p class="error" *ngIf="appointmentErrorMessage">{{ appointmentErrorMessage }}</p>
      <p class="success" *ngIf="appointmentSuccessMessage">{{ appointmentSuccessMessage }}</p>

      <div class="appointments-table" *ngIf="modalAppointments.length">
        <table>
          <thead>
            <tr>
              <th>تاریخ و ساعت</th>
              <th>نوع نوبت</th>
              <th>توضیحات</th>
              <th>وضعیت</th>
              <th>مدیریت</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let appointment of modalAppointments">
              <td>{{ appointment.date }} - {{ appointment.time }}</td>
              <td>{{ appointment.service }}</td>
              <td>{{ appointment.notes || '---' }}</td>
              <td>
                <span
                  class="status-pill"
                  [class.done]="appointment.status === 'completed'"
                  [class.canceled]="appointment.status === 'canceled'"
                >
                  {{
                    appointment.status === 'scheduled'
                      ? 'رزرو شده'
                      : appointment.status === 'confirmed'
                      ? 'تایید شده'
                      : appointment.status === 'completed'
                      ? 'انجام شده'
                      : 'لغو شده'
                  }}
                </span>
              </td>
              <td>
                <div class="table-actions">
                  <button
                    type="button"
                    class="outline"
                    (click)="updateAppointmentStatus(appointment, 'confirmed')"
                  >
                    تایید
                  </button>
                  <button type="button" class="outline" (click)="updateAppointmentStatus(appointment, 'completed')">
                    انجام شد
                  </button>
                  <button type="button" class="outline" (click)="updateAppointmentStatus(appointment, 'canceled')">
                    لغو
                  </button>
                  <button type="button" class="danger" (click)="deleteAppointment(appointment)">حذف</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <p class="muted" *ngIf="!modalAppointments.length">نوبتی ثبت نشده است.</p>
    </ng-container>

    <ng-container *ngIf="modalActiveTab === 'treatment'">
      <div class="treatment-header">
        <div>
          <p class="muted">طرح درمان را از روی تصویر انتخاب کنید و توضیحات لازم را ثبت کنید.</p>
          <p class="muted" *ngIf="!formData.id">برای ذخیره طرح درمان ابتدا باید مشتری ذخیره شود.</p>
        </div>
        <div class="table-actions">
          <button type="button" class="outline" (click)="clearTreatmentSelection()">پاک کردن انتخاب‌ها</button>
        </div>
      </div>

      <div class="treatment-content">
        <div class="treatment-diagram">
          <svg class="teeth-diagram" viewBox="0 0 757 335" aria-label="نقشه دندان‌ها">
            <path
              class="mouth-shape"
              d="M378 327.906C378 327.906 378.46 326.641 322.934 327.906C267.408 329.171 206.093 304.434 179.76 280.92C153.427 257.406 111.967 185.863 90.653 138.961C69.339 92.059 22.7 35.51 18.566 29.993C14.432 24.476 15.426 18.623 20.566 19.993C25.706 21.363 56.316 32.993 84.643 32.993C112.97 32.993 128.933 7 238.831 7C336.283 7 367.993 35.992 367.993 35.992C367.993 35.992 379.781 43.318 389.225 35.992C389.225 35.994 427.954 7 518.3 7C628.135 7 644.086 32.995 672.4 32.995C700.714 32.995 731.3 21.37 736.439 19.995C741.578 18.62 742.575 24.476 738.439 29.995C734.303 35.514 687.697 92.067 666.395 138.974C645.093 185.881 603.659 257.431 577.342 280.947C551.025 304.463 489.748 329.203 434.255 327.937C378.762 326.671 379.222 327.937 379.222 327.937C378.82 328.046 378.396 328.036 378 327.906V327.906Z"
            ></path>
            <path
              class="gum-shape"
              d="M378.247 302.863C378.247 302.863 378.681 301.795 326.339 302.863C273.997 303.931 216.2 283.051 191.379 263.2C166.558 243.349 127.479 182.966 107.379 143.377C87.279 103.788 43.331 56.06 39.431 51.4C35.531 46.74 36.471 41.8 41.319 42.962C46.167 44.124 75.019 53.932 101.719 53.932C128.419 53.932 143.468 32 247.062 32C338.923 32 368.815 56.471 368.815 56.471C368.815 56.471 379.926 62.655 388.829 56.471C388.829 56.471 425.336 31.998 510.502 31.998C614.034 32 629.07 53.937 655.756 53.937C682.442 53.937 711.277 44.125 716.122 42.966C720.967 41.807 721.906 46.748 718.008 51.405C714.11 56.062 670.177 103.8 650.1 143.391C630.023 182.982 590.963 243.377 566.155 263.226C541.347 283.075 483.586 303.958 431.276 302.89C378.966 301.822 379.4 302.89 379.4 302.89C379.02 302.982 378.622 302.973 378.247 302.863Z"
            ></path>
            <ng-container *ngFor="let tooth of treatmentUpperTeeth">
              <g
                class="tooth"
                [class.selected]="isToothSelected(tooth.id)"
                (click)="toggleTooth(tooth)"
                role="button"
                tabindex="0"
                (keydown.enter)="toggleTooth(tooth)"
                (keydown.space)="toggleTooth(tooth)"
              >
                <rect class="tooth-shape" [attr.x]="tooth.x" [attr.y]="tooth.y" width="26" height="32" rx="10"></rect>
                <text class="tooth-label" [attr.x]="tooth.x + 13" [attr.y]="tooth.y + 18">
                  {{ getPersianNumber(tooth.label) }}
                </text>
              </g>
            </ng-container>
            <ng-container *ngFor="let tooth of treatmentLowerTeeth">
              <g
                class="tooth"
                [class.selected]="isToothSelected(tooth.id)"
                (click)="toggleTooth(tooth)"
                role="button"
                tabindex="0"
                (keydown.enter)="toggleTooth(tooth)"
                (keydown.space)="toggleTooth(tooth)"
              >
                <rect class="tooth-shape" [attr.x]="tooth.x" [attr.y]="tooth.y" width="26" height="32" rx="10"></rect>
                <text class="tooth-label" [attr.x]="tooth.x + 13" [attr.y]="tooth.y + 18">
                  {{ getPersianNumber(tooth.label) }}
                </text>
              </g>
            </ng-container>
          </svg>
          <p class="muted">برای انتخاب هر دندان روی آن کلیک کنید.</p>
        </div>

        <div class="treatment-details">
          <h4>دندان‌های انتخاب شده</h4>
          <div class="selected-teeth" *ngIf="selectedTreatmentTeeth.length; else noSelectedTeeth">
            <span class="tooth-chip" *ngFor="let tooth of selectedTreatmentTeeth">
              {{ tooth.archLabel }} {{ getPersianNumber(tooth.label) }}
            </span>
          </div>
          <ng-template #noSelectedTeeth>
            <p class="muted">هنوز دندانی انتخاب نشده است.</p>
          </ng-template>

          <div class="treatment-services">
            <h5>خدمات هر دندان</h5>
            <div *ngIf="selectedTreatmentTeeth.length; else noServices">
              <div class="service-row" *ngFor="let tooth of selectedTreatmentTeeth">
                <span class="service-tooth">{{ tooth.archLabel }} {{ getPersianNumber(tooth.label) }}</span>
                <select
                  [ngModel]="getToothService(tooth.id).serviceValue"
                  (ngModelChange)="updateToothService(tooth.id, $event)"
                >
                  <option *ngFor="let service of treatmentServiceOptions" [ngValue]="service.value">
                    {{ service.label }}
                  </option>
                </select>
                <input
                  type="number"
                  min="0"
                  [ngModel]="getToothService(tooth.id).price"
                  (ngModelChange)="updateToothPrice(tooth.id, $event)"
                  placeholder="قیمت (تومان)"
                />
              </div>
            </div>
            <ng-template #noServices>
              <p class="muted">برای ثبت خدمات ابتدا دندان انتخاب کنید.</p>
            </ng-template>
          </div>

          <div class="treatment-summary">
            <div class="summary-row">
              <span>جمع کل طرح درمان</span>
              <strong>{{ formatPrice(treatmentTotal) }} تومان</strong>
            </div>
            <label>
              پیش پرداخت
              <input
                type="number"
                min="0"
                [ngModel]="treatmentPrepaymentAmount"
                (ngModelChange)="updatePrepaymentAmount($event)"
                placeholder="مبلغ پیش پرداخت (تومان)"
              />
            </label>
            <div class="summary-row">
              <span>مانده پس از پیش پرداخت</span>
              <strong>{{ formatPrice(remainingBalance) }} تومان</strong>
            </div>
            <label>
              طرح اقساطی
              <select
                [ngModel]="selectedInstallmentMonths"
                (ngModelChange)="updateInstallmentPlan($event)"
              >
                <option *ngFor="let plan of installmentPlanOptions" [ngValue]="plan.months">
                  {{ plan.label }}
                </option>
              </select>
            </label>
            <div class="summary-row">
              <span>مبلغ هر قسط</span>
              <strong>{{ formatPrice(installmentMonthlyPayment) }} تومان</strong>
            </div>
            <div class="treatment-checks">
              <h5>ثبت چک‌ها</h5>
              <div class="check-grid check-form">
                <label>
                  تاریخ چک
                  <input
                    type="date"
                    [(ngModel)]="newChequeDate"
                  />
                </label>
                <label>
                  مبلغ چک
                  <input
                    type="number"
                    min="0"
                    [ngModel]="newChequeAmount"
                    (ngModelChange)="updateChequeAmount($event)"
                    placeholder="مبلغ چک (تومان)"
                  />
                </label>
                <label>
                  شماره چک
                  <input
                    type="text"
                    [(ngModel)]="newChequeNumber"
                    placeholder="شماره چک"
                  />
                </label>
                <label>
                  صاحب چک
                  <input
                    type="text"
                    [(ngModel)]="newChequeOwner"
                    placeholder="نام صاحب چک"
                  />
                </label>
              </div>
              <button class="outline add-check" type="button" (click)="addCheque()">افزودن چک</button>
              <div class="checks-list" *ngIf="treatmentCheques.length; else noChecks">
                <div class="check-item" *ngFor="let cheque of treatmentCheques">
                  <div>
                    <strong>{{ cheque.number || 'چک بدون شماره' }}</strong>
                    <p class="muted">
                      {{ cheque.date ? ('تاریخ: ' + cheque.date) : 'بدون تاریخ' }} ·
                      مبلغ: {{ formatPrice(cheque.amount) }} تومان ·
                      صاحب: {{ cheque.owner || '---' }}
                    </p>
                  </div>
                  <button class="ghost" type="button" (click)="removeCheque(cheque.id)">حذف</button>
                </div>
              </div>
              <ng-template #noChecks>
                <p class="muted">هنوز چکی ثبت نشده است.</p>
              </ng-template>
            </div>
          </div>

          <label class="treatment-notes">
            توضیحات طرح درمان
            <textarea
              rows="4"
              name="treatmentNotes"
              [(ngModel)]="treatmentPlanNote"
              (ngModelChange)="persistTreatmentPlan()"
            ></textarea>
          </label>

          <div class="treatment-plan-card">
            <h5>جمع‌بندی طرح درمان</h5>
            <div class="plan-row">
              <span>جمع کل</span>
              <strong>{{ formatPrice(treatmentTotal) }} تومان</strong>
            </div>
            <div class="plan-row">
              <span>پیش پرداخت</span>
              <strong>{{ formatPrice(treatmentPrepaymentAmount) }} تومان</strong>
            </div>
            <div class="plan-row">
              <span>مانده</span>
              <strong>{{ formatPrice(remainingBalance) }} تومان</strong>
            </div>
            <div class="plan-row">
              <span>طرح اقساطی</span>
              <strong>{{ getPersianNumber(selectedInstallmentMonths) }} ماهه</strong>
            </div>
            <div class="plan-row">
              <span>مبلغ هر قسط</span>
              <strong>{{ formatPrice(installmentMonthlyPayment) }} تومان</strong>
            </div>
            <div class="plan-row">
              <span>جمع چک‌ها</span>
              <strong>{{ formatPrice(totalChequeAmount) }} تومان</strong>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</div>

<section class="card">
  <header class="section-header">
    <div>
      <h2>لیست مشتری‌ها</h2>
      <p class="muted">نمایش مشتری‌ها همراه با اطلاعات تماس و انتخاب برای مشاهده تماس‌ها.</p>
    </div>
    <button class="outline" (click)="loadClients()" [disabled]="isLoadingClients">
      {{ isLoadingClients ? 'در حال دریافت...' : 'به‌روزرسانی' }}
    </button>
  </header>

  <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>

  <div class="table-wrapper" *ngIf="clients.length">
    <table class="clients-table">
      <thead>
        <tr>
          <th>نام و نام خانوادگی</th>
          <th>عنوان</th>
          <th>موبایل ۱</th>
          <th>موبایل ۲</th>
          <th>تلفن ثابت</th>
          <th>ایمیل</th>
          <th>تماس‌ها</th>
          <th>مدیریت</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let client of clients" [class.active]="client === selectedClient">
          <td>{{ client.firstName }} {{ client.lastName }}</td>
          <td>{{ client.title || 'بدون عنوان' }}</td>
          <td>{{ client.mobileNumber1 || '---' }}</td>
          <td>{{ client.mobileNumber2 || '---' }}</td>
          <td>{{ client.phoneNumber || '---' }}</td>
          <td>{{ client.email || '---' }}</td>
          <td>
            <div class="table-actions">
              <button (click)="selectClient(client, client.mobileNumber1)">موبایل ۱</button>
              <button class="outline" (click)="selectClient(client, client.mobileNumber2)">موبایل ۲</button>
              <button class="outline" (click)="selectClient(client, client.phoneNumber)">تلفن ثابت</button>
            </div>
          </td>
          <td>
            <div class="table-actions">
              <button class="outline" (click)="startEditClient(client)">ویرایش</button>
              <button class="danger" (click)="deleteClient(client)">حذف</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <p class="muted" *ngIf="!clients.length && !isLoadingClients">مشتری‌ای برای نمایش وجود ندارد.</p>
</section>

<section class="card" *ngIf="selectedClient">
  <header class="section-header">
    <div>
      <h2>تماس‌های مشتری</h2>
      <p class="muted">
        {{ selectedClient.firstName }} {{ selectedClient.lastName }} - شماره انتخابی: {{ selectedPhone || '---' }}
      </p>
    </div>
  </header>

  <div class="filters">
    <label>
      از تاریخ
      <input type="date" [(ngModel)]="startDate" />
    </label>
    <label>
      تا تاریخ
      <input type="date" [(ngModel)]="endDate" />
    </label>
    <button (click)="loadCallRecords()" [disabled]="isLoadingCalls">
      {{ isLoadingCalls ? 'در حال دریافت...' : 'نمایش تماس‌ها' }}
    </button>
  </div>

  <p class="error" *ngIf="callsErrorMessage">{{ callsErrorMessage }}</p>

  <div class="calls" *ngIf="callRecords.length">
    <table>
      <thead>
        <tr>
          <th>تاریخ تماس</th>
          <th>تماس‌گیرنده</th>
          <th>شماره مقصد</th>
          <th>مدت زمان</th>
          <th>وضعیت</th>
          <th>فایل ضبط</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let call of callRecords">
          <td>{{ call.callDate | date: 'yyyy/MM/dd HH:mm' }}</td>
          <td>{{ call.src }}</td>
          <td>{{ call.dst }}</td>
          <td>{{ call.duration }} ثانیه</td>
          <td>{{ call.disposition }}</td>
          <td>
            <ng-container *ngIf="call.recordingFile; else noRecording">
              <audio controls [src]="getRecordingUrl(call.recordingFile)"></audio>
              <a
                class="recording-link"
                [href]="getRecordingUrl(call.recordingFile)"
                target="_blank"
                rel="noopener"
              >
                پخش در تب جدید
              </a>
            </ng-container>
            <ng-template #noRecording>---</ng-template>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <p class="muted" *ngIf="!callRecords.length && !isLoadingCalls">تماسی برای این بازه زمانی ثبت نشده است.</p>
</section>
