<section class="card form-card">
  <header class="section-header">
    <div>
      <h2>مدیریت مشتری‌ها</h2>
      <p class="muted">افزودن مشتری جدید یا ویرایش اطلاعات مشتری‌های ثبت شده.</p>
    </div>
    <button class="outline" type="button" (click)="startCreateClient()" [disabled]="isSubmitting">
      افزودن مشتری جدید
    </button>
  </header>

  <p class="success" *ngIf="formSuccessMessage">{{ formSuccessMessage }}</p>
</section>

<div class="modal-backdrop" *ngIf="isFormModalOpen" (click)="closeFormModal()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <div>
        <h3>{{ isEditMode ? 'ویرایش اطلاعات مشتری' : 'ثبت مشتری جدید' }}</h3>
        <p class="muted">اطلاعات مشتری را وارد کنید.</p>
      </div>
      <button type="button" class="close-button" (click)="closeFormModal()" [disabled]="isSubmitting">
        بستن
      </button>
    </header>

    <div class="modal-tabs">
      <button
        type="button"
        [class.active]="modalActiveTab === 'details'"
        (click)="setModalTab('details')"
      >
        اطلاعات
      </button>
      <button
        type="button"
        [class.active]="modalActiveTab === 'calls'"
        (click)="setModalTab('calls')"
      >
        تماس‌ها
      </button>
      <button
        type="button"
        [class.active]="modalActiveTab === 'tasks'"
        (click)="setModalTab('tasks')"
      >
        پیگیری‌ها
      </button>
    </div>

    <p class="error" *ngIf="formErrorMessage">{{ formErrorMessage }}</p>

    <ng-container *ngIf="modalActiveTab === 'details'">
      <form class="client-form" (ngSubmit)="submitClient()">
        <div class="form-grid">
          <label>
            نام
            <input type="text" name="firstName" [(ngModel)]="formData.firstName" />
          </label>
          <label>
            نام خانوادگی
            <input type="text" name="lastName" [(ngModel)]="formData.lastName" />
          </label>
          <label>
            عنوان
            <input type="text" name="title" [(ngModel)]="formData.title" required />
          </label>
          <label>
            موبایل ۱
            <input type="text" name="mobileNumber1" [(ngModel)]="formData.mobileNumber1" required />
          </label>
          <label>
            موبایل ۲
            <input type="text" name="mobileNumber2" [(ngModel)]="formData.mobileNumber2" />
          </label>
          <label>
            تلفن ثابت
            <input type="text" name="phoneNumber" [(ngModel)]="formData.phoneNumber" />
          </label>
          <label>
            ایمیل
            <input type="email" name="email" [(ngModel)]="formData.email" />
          </label>
          <label>
            تاریخ تولد
            <input type="date" name="birthDay" [(ngModel)]="formData.birthDay" />
          </label>
          <label>
            نوع خدمات
            <select name="dentalService" [(ngModel)]="formData.dentalService">
              <option *ngFor="let service of dentalServiceOptions" [ngValue]="service.value">
                {{ service.label }}
              </option>
            </select>
          </label>
          <label class="full">
            آدرس
            <input type="text" name="address" [(ngModel)]="formData.address" />
          </label>
          <label>
            استان
            <input type="text" name="province" [(ngModel)]="formData.province" />
          </label>
          <label>
            شهر
            <input type="text" name="city" [(ngModel)]="formData.city" />
          </label>
          <label>
            کد پستی
            <input type="text" name="postalCode" [(ngModel)]="formData.postalCode" />
          </label>
          <label>
            کشور
            <input type="text" name="country" [(ngModel)]="formData.country" />
          </label>
          <label class="full">
            توضیحات
            <textarea name="description" rows="3" [(ngModel)]="formData.description"></textarea>
          </label>
        </div>
        <div class="form-actions">
          <button type="submit" [disabled]="isSubmitting">
            {{ isEditMode ? 'ذخیره تغییرات' : 'ثبت مشتری' }}
          </button>
          <button type="button" class="outline" (click)="startCreateClient()" [disabled]="isSubmitting">
            پاک کردن فرم
          </button>
        </div>
      </form>
    </ng-container>

    <ng-container *ngIf="modalActiveTab === 'calls'">
      <div class="modal-calls-header">
        <div>
          <p class="muted">تماس‌های مرتبط با موبایل مشتری را بررسی کنید.</p>
          <p class="muted">شماره انتخابی: {{ modalSelectedPhone || '---' }}</p>
        </div>
        <div class="table-actions">
          <button
            type="button"
            class="outline"
            (click)="selectModalPhone(formData.mobileNumber1)"
            [disabled]="!formData.mobileNumber1"
          >
            موبایل ۱
          </button>
          <button
            type="button"
            class="outline"
            (click)="selectModalPhone(formData.mobileNumber2)"
            [disabled]="!formData.mobileNumber2"
          >
            موبایل ۲
          </button>
        </div>
      </div>

      <div class="filters">
        <label>
          از تاریخ
          <input type="date" [(ngModel)]="startDate" />
        </label>
        <label>
          تا تاریخ
          <input type="date" [(ngModel)]="endDate" />
        </label>
        <button type="button" (click)="loadModalCallRecords()" [disabled]="modalIsLoadingCalls">
          {{ modalIsLoadingCalls ? 'در حال دریافت...' : 'نمایش تماس‌ها' }}
        </button>
      </div>

      <p class="error" *ngIf="modalCallsErrorMessage">{{ modalCallsErrorMessage }}</p>

      <div class="calls" *ngIf="modalCallRecords.length">
        <table>
          <thead>
            <tr>
              <th>تاریخ تماس</th>
              <th>تماس‌گیرنده</th>
              <th>شماره مقصد</th>
              <th>مدت زمان</th>
              <th>وضعیت</th>
              <th>فایل ضبط</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let call of modalCallRecords">
              <td>{{ call.callDate | date: 'yyyy/MM/dd HH:mm' }}</td>
              <td>{{ call.src }}</td>
              <td>{{ call.dst }}</td>
              <td>{{ call.duration }} ثانیه</td>
              <td>{{ call.disposition }}</td>
              <td>
                <ng-container *ngIf="call.recordingFile; else modalNoRecording">
                  <audio controls [src]="getRecordingUrl(call.recordingFile)"></audio>
                  <a
                    class="recording-link"
                    [href]="getRecordingUrl(call.recordingFile)"
                    target="_blank"
                    rel="noopener"
                  >
                    پخش در تب جدید
                  </a>
                </ng-container>
                <ng-template #modalNoRecording>---</ng-template>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <p class="muted" *ngIf="!modalCallRecords.length && !modalIsLoadingCalls">
        تماسی برای نمایش وجود ندارد.
      </p>
    </ng-container>

    <ng-container *ngIf="modalActiveTab === 'tasks'">
      <div class="tasks-header">
        <div>
          <p class="muted">برای هر مشتری پیگیری ثبت کنید تا در تاریخ و ساعت مشخص یادآوری شود.</p>
          <p class="muted" *ngIf="!formData.id">برای ثبت پیگیری ابتدا باید مشتری ذخیره شود.</p>
        </div>
      </div>

      <div class="task-form">
        <label>
          تاریخ
          <input type="date" name="taskDate" [(ngModel)]="taskForm.date" />
        </label>
        <label>
          ساعت
          <input type="time" name="taskTime" [(ngModel)]="taskForm.time" />
        </label>
        <label class="full">
          موضوع پیگیری
          <input type="text" name="taskSubject" [(ngModel)]="taskForm.subject" />
        </label>
        <label class="full">
          توضیحات تکمیلی
          <textarea name="taskDescription" rows="3" [(ngModel)]="taskForm.description"></textarea>
        </label>
      </div>

      <div class="form-actions">
        <button type="button" (click)="addTask()" [disabled]="!canAddTask()">
          ثبت پیگیری
        </button>
        <button type="button" class="outline" (click)="resetTaskForm()">
          پاک کردن
        </button>
      </div>

      <p class="error" *ngIf="taskErrorMessage">{{ taskErrorMessage }}</p>
      <p class="success" *ngIf="taskSuccessMessage">{{ taskSuccessMessage }}</p>

      <div class="tasks-table" *ngIf="modalTasks.length">
        <table>
          <thead>
            <tr>
              <th>تاریخ و ساعت</th>
              <th>موضوع</th>
              <th>توضیحات</th>
              <th>وضعیت</th>
              <th>مدیریت</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let task of modalTasks">
              <td>{{ task.date }} - {{ task.time }}</td>
              <td>{{ task.subject }}</td>
              <td>{{ task.description || '---' }}</td>
              <td>
                <span class="status-pill" [class.done]="task.isDone">
                  {{ task.isDone ? 'انجام شد' : 'در انتظار' }}
                </span>
              </td>
              <td>
                <div class="table-actions">
                  <button type="button" class="outline" (click)="toggleTaskDone(task)">
                    {{ task.isDone ? 'بازگشت' : 'انجام شد' }}
                  </button>
                  <button type="button" class="danger" (click)="deleteTask(task)">حذف</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <p class="muted" *ngIf="!modalTasks.length">پیگیری ثبت نشده است.</p>
    </ng-container>
  </div>
</div>

<section class="card">
  <header class="section-header">
    <div>
      <h2>لیست مشتری‌ها</h2>
      <p class="muted">نمایش مشتری‌ها همراه با اطلاعات تماس و انتخاب برای مشاهده تماس‌ها.</p>
    </div>
    <button class="outline" (click)="loadClients()" [disabled]="isLoadingClients">
      {{ isLoadingClients ? 'در حال دریافت...' : 'به‌روزرسانی' }}
    </button>
  </header>

  <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>

  <div class="table-wrapper" *ngIf="clients.length">
    <table class="clients-table">
      <thead>
        <tr>
          <th>نام و نام خانوادگی</th>
          <th>عنوان</th>
          <th>موبایل ۱</th>
          <th>موبایل ۲</th>
          <th>تلفن ثابت</th>
          <th>ایمیل</th>
          <th>تماس‌ها</th>
          <th>مدیریت</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let client of clients" [class.active]="client === selectedClient">
          <td>{{ client.firstName }} {{ client.lastName }}</td>
          <td>{{ client.title || 'بدون عنوان' }}</td>
          <td>{{ client.mobileNumber1 || '---' }}</td>
          <td>{{ client.mobileNumber2 || '---' }}</td>
          <td>{{ client.phoneNumber || '---' }}</td>
          <td>{{ client.email || '---' }}</td>
          <td>
            <div class="table-actions">
              <button (click)="selectClient(client, client.mobileNumber1)">موبایل ۱</button>
              <button class="outline" (click)="selectClient(client, client.mobileNumber2)">موبایل ۲</button>
              <button class="outline" (click)="selectClient(client, client.phoneNumber)">تلفن ثابت</button>
            </div>
          </td>
          <td>
            <div class="table-actions">
              <button class="outline" (click)="startEditClient(client)">ویرایش</button>
              <button class="danger" (click)="deleteClient(client)">حذف</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <p class="muted" *ngIf="!clients.length && !isLoadingClients">مشتری‌ای برای نمایش وجود ندارد.</p>
</section>

<section class="card" *ngIf="selectedClient">
  <header class="section-header">
    <div>
      <h2>تماس‌های مشتری</h2>
      <p class="muted">
        {{ selectedClient.firstName }} {{ selectedClient.lastName }} - شماره انتخابی: {{ selectedPhone || '---' }}
      </p>
    </div>
  </header>

  <div class="filters">
    <label>
      از تاریخ
      <input type="date" [(ngModel)]="startDate" />
    </label>
    <label>
      تا تاریخ
      <input type="date" [(ngModel)]="endDate" />
    </label>
    <button (click)="loadCallRecords()" [disabled]="isLoadingCalls">
      {{ isLoadingCalls ? 'در حال دریافت...' : 'نمایش تماس‌ها' }}
    </button>
  </div>

  <p class="error" *ngIf="callsErrorMessage">{{ callsErrorMessage }}</p>

  <div class="calls" *ngIf="callRecords.length">
    <table>
      <thead>
        <tr>
          <th>تاریخ تماس</th>
          <th>تماس‌گیرنده</th>
          <th>شماره مقصد</th>
          <th>مدت زمان</th>
          <th>وضعیت</th>
          <th>فایل ضبط</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let call of callRecords">
          <td>{{ call.callDate | date: 'yyyy/MM/dd HH:mm' }}</td>
          <td>{{ call.src }}</td>
          <td>{{ call.dst }}</td>
          <td>{{ call.duration }} ثانیه</td>
          <td>{{ call.disposition }}</td>
          <td>
            <ng-container *ngIf="call.recordingFile; else noRecording">
              <audio controls [src]="getRecordingUrl(call.recordingFile)"></audio>
              <a
                class="recording-link"
                [href]="getRecordingUrl(call.recordingFile)"
                target="_blank"
                rel="noopener"
              >
                پخش در تب جدید
              </a>
            </ng-container>
            <ng-template #noRecording>---</ng-template>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <p class="muted" *ngIf="!callRecords.length && !isLoadingCalls">تماسی برای این بازه زمانی ثبت نشده است.</p>
</section>
