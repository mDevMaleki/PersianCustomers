<section class="card form-card">
  <header class="section-header">
    <div>
      <h2>مدیریت مشتری‌ها</h2>
      <p class="muted">افزودن مشتری جدید یا ویرایش اطلاعات مشتری‌های ثبت شده.</p>
    </div>
    <button class="outline" type="button" (click)="startCreateClient()" [disabled]="isSubmitting">
      افزودن مشتری جدید
    </button>
  </header>

  <p class="success" *ngIf="formSuccessMessage">{{ formSuccessMessage }}</p>
</section>

<div class="modal-backdrop" *ngIf="isFormModalOpen" (click)="closeFormModal()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <div>
        <h3>{{ isEditMode ? 'ویرایش اطلاعات مشتری' : 'ثبت مشتری جدید' }}</h3>
        <p class="muted">اطلاعات مشتری را وارد کنید.</p>
      </div>
      <button type="button" class="close-button" (click)="closeFormModal()" [disabled]="isSubmitting">
        بستن
      </button>
    </header>

    <p class="error" *ngIf="formErrorMessage">{{ formErrorMessage }}</p>

    <form class="client-form" (ngSubmit)="submitClient()">
      <div class="form-grid">
        <label>
          نام
          <input type="text" name="firstName" [(ngModel)]="formData.firstName" />
        </label>
        <label>
          نام خانوادگی
          <input type="text" name="lastName" [(ngModel)]="formData.lastName" />
        </label>
        <label>
          عنوان
          <input type="text" name="title" [(ngModel)]="formData.title" required />
        </label>
        <label>
          موبایل ۱
          <input type="text" name="mobileNumber1" [(ngModel)]="formData.mobileNumber1" required />
        </label>
        <label>
          موبایل ۲
          <input type="text" name="mobileNumber2" [(ngModel)]="formData.mobileNumber2" />
        </label>
        <label>
          تلفن ثابت
          <input type="text" name="phoneNumber" [(ngModel)]="formData.phoneNumber" />
        </label>
        <label>
          ایمیل
          <input type="email" name="email" [(ngModel)]="formData.email" />
        </label>
        <label>
          تاریخ تولد
          <input type="date" name="birthDay" [(ngModel)]="formData.birthDay" />
        </label>
        <label>
          نوع خدمات
          <select name="dentalService" [(ngModel)]="formData.dentalService">
            <option *ngFor="let service of dentalServiceOptions" [ngValue]="service.value">
              {{ service.label }}
            </option>
          </select>
        </label>
        <label class="full">
          آدرس
          <input type="text" name="address" [(ngModel)]="formData.address" />
        </label>
        <label>
          استان
          <input type="text" name="province" [(ngModel)]="formData.province" />
        </label>
        <label>
          شهر
          <input type="text" name="city" [(ngModel)]="formData.city" />
        </label>
        <label>
          کد پستی
          <input type="text" name="postalCode" [(ngModel)]="formData.postalCode" />
        </label>
        <label>
          کشور
          <input type="text" name="country" [(ngModel)]="formData.country" />
        </label>
        <label class="full">
          توضیحات
          <textarea name="description" rows="3" [(ngModel)]="formData.description"></textarea>
        </label>
      </div>
      <div class="form-actions">
        <button type="submit" [disabled]="isSubmitting">
          {{ isEditMode ? 'ذخیره تغییرات' : 'ثبت مشتری' }}
        </button>
        <button type="button" class="outline" (click)="startCreateClient()" [disabled]="isSubmitting">
          پاک کردن فرم
        </button>
      </div>
    </form>
  </div>
</div>

<section class="card">
  <header class="section-header">
    <div>
      <h2>لیست مشتری‌ها</h2>
      <p class="muted">نمایش مشتری‌ها همراه با اطلاعات تماس و انتخاب برای مشاهده تماس‌ها.</p>
    </div>
    <button class="outline" (click)="loadClients()" [disabled]="isLoadingClients">
      {{ isLoadingClients ? 'در حال دریافت...' : 'به‌روزرسانی' }}
    </button>
  </header>

  <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>

  <div class="table-wrapper" *ngIf="clients.length">
    <table class="clients-table">
      <thead>
        <tr>
          <th>نام و نام خانوادگی</th>
          <th>عنوان</th>
          <th>موبایل ۱</th>
          <th>موبایل ۲</th>
          <th>تلفن ثابت</th>
          <th>ایمیل</th>
          <th>تماس‌ها</th>
          <th>مدیریت</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let client of clients" [class.active]="client === selectedClient">
          <td>{{ client.firstName }} {{ client.lastName }}</td>
          <td>{{ client.title || 'بدون عنوان' }}</td>
          <td>{{ client.mobileNumber1 || '---' }}</td>
          <td>{{ client.mobileNumber2 || '---' }}</td>
          <td>{{ client.phoneNumber || '---' }}</td>
          <td>{{ client.email || '---' }}</td>
          <td>
            <div class="table-actions">
              <button (click)="selectClient(client, client.mobileNumber1)">موبایل ۱</button>
              <button class="outline" (click)="selectClient(client, client.mobileNumber2)">موبایل ۲</button>
              <button class="outline" (click)="selectClient(client, client.phoneNumber)">تلفن ثابت</button>
            </div>
          </td>
          <td>
            <div class="table-actions">
              <button class="outline" (click)="startEditClient(client)">ویرایش</button>
              <button class="danger" (click)="deleteClient(client)">حذف</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <p class="muted" *ngIf="!clients.length && !isLoadingClients">مشتری‌ای برای نمایش وجود ندارد.</p>
</section>

<section class="card" *ngIf="selectedClient">
  <header class="section-header">
    <div>
      <h2>تماس‌های مشتری</h2>
      <p class="muted">
        {{ selectedClient.firstName }} {{ selectedClient.lastName }} - شماره انتخابی: {{ selectedPhone || '---' }}
      </p>
    </div>
  </header>

  <div class="filters">
    <label>
      از تاریخ
      <input type="date" [(ngModel)]="startDate" />
    </label>
    <label>
      تا تاریخ
      <input type="date" [(ngModel)]="endDate" />
    </label>
    <button (click)="loadCallRecords()" [disabled]="isLoadingCalls">
      {{ isLoadingCalls ? 'در حال دریافت...' : 'نمایش تماس‌ها' }}
    </button>
  </div>

  <p class="error" *ngIf="callsErrorMessage">{{ callsErrorMessage }}</p>

  <div class="calls" *ngIf="callRecords.length">
    <table>
      <thead>
        <tr>
          <th>تاریخ تماس</th>
          <th>تماس‌گیرنده</th>
          <th>شماره مقصد</th>
          <th>مدت زمان</th>
          <th>وضعیت</th>
          <th>فایل ضبط</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let call of callRecords">
          <td>{{ call.callDate | date: 'yyyy/MM/dd HH:mm' }}</td>
          <td>{{ call.src }}</td>
          <td>{{ call.dst }}</td>
          <td>{{ call.duration }} ثانیه</td>
          <td>{{ call.disposition }}</td>
          <td>
            <ng-container *ngIf="call.recordingFile; else noRecording">
              <audio controls [src]="getRecordingUrl(call.recordingFile)"></audio>
              <a
                class="recording-link"
                [href]="getRecordingUrl(call.recordingFile)"
                target="_blank"
                rel="noopener"
              >
                پخش در تب جدید
              </a>
            </ng-container>
            <ng-template #noRecording>---</ng-template>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <p class="muted" *ngIf="!callRecords.length && !isLoadingCalls">تماسی برای این بازه زمانی ثبت نشده است.</p>
</section>
